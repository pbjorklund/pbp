#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

# Generated bundle header; do not edit in bin/pbproject
# Source modules are in src/

PBPROJECT_VERSION="${PBPROJECT_VERSION:-unknown}"
PBPROJECT_BUILD_TIME="${PBPROJECT_BUILD_TIME:-unknown}"
print_version_note() { echo "pbproject version: ${PBPROJECT_VERSION} (${PBPROJECT_BUILD_TIME})"; }
# Version: v1.0.1
# Built: 2025-08-13T12:38:11Z
PBPROJECT_VERSION='v1.0.1'
PBPROJECT_BUILD_TIME='2025-08-13T12:38:11Z'

# >>> /home/pbjorklund/Projects/pbproject/src/lib/core.sh
# Paths and globals
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
PBPROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SCRIPT_NAME="$(basename "$0")"
PROJECTS_DIR="$HOME/Projects"

# >>> /home/pbjorklund/Projects/pbproject/src/lib/ui.sh
info() { echo "â„¹ï¸  $1"; }
success() { echo "âœ… $1"; }
error() { echo "âŒ Error: $1" >&2; exit 1; }

# >>> /home/pbjorklund/Projects/pbproject/src/tasks/github.sh
create_github_repo() {
  local project_path="${1:-$PWD}"; cd "$project_path"
  if [[ ! -d .git ]]; then error "Not in a git repository. Run this command in a project directory."; fi
  if ! command -v gh &>/dev/null; then error "GitHub CLI (gh) is not installed. Install it with: dnf install gh"; fi
  if ! gh auth status &>/dev/null; then error "Not authenticated with GitHub. Run: gh auth login"; fi
  local project_name; project_name=$(basename "$project_path")
  local current_remote=""; if git remote get-url origin &>/dev/null; then current_remote=$(git remote get-url origin); info "Current remote origin: $current_remote"
    if [[ "$current_remote" == *"github.com"* ]]; then
      local username expected_remote expected_https; username=$(gh api user --jq .login); expected_remote="git@github.com:$username/$project_name.git"; expected_https="https://github.com/$username/$project_name.git"
      if [[ "$current_remote" == "$expected_remote" ]] || [[ "$current_remote" == "$expected_https" ]]; then
        info "GitHub repository already configured correctly"
        if git log origin/"$(git branch --show-current)" 2>/dev/null; then info "Repository is up to date"; else info "Attempting to push unpushed commits"; if git push origin "$(git branch --show-current)"; then success "Successfully pushed to existing repository"; else error "Failed to push to existing repository. Check SSH keys or run manually: git push origin $(git branch --show-current)"; fi; fi
        return
      else info "Different GitHub repository already configured: $current_remote"; return; fi
    fi
  fi
  local username; username=$(gh api user --jq .login)
  if gh repo view "$username/$project_name" &>/dev/null; then
    info "Repository $username/$project_name already exists on GitHub"
    if [[ -z "$current_remote" ]]; then info "Adding remote origin"; git remote add origin "git@github.com:$username/$project_name.git"; success "Added remote origin"; fi
    info "Attempting to push to existing repository"; if git push -u origin "$(git branch --show-current)"; then success "Successfully pushed to existing repository"; success "Repository URL: https://github.com/$username/$project_name"; else error "Failed to push to repository. Check SSH keys or run manually: git push -u origin $(git branch --show-current)"; fi; return
  fi
  info "Creating private GitHub repository: $project_name"
  if gh repo create "$project_name" --private --source=. --remote=origin; then
    success "GitHub repository created successfully"; info "Pushing code to repository"
    if git push -u origin "$(git branch --show-current)"; then success "Code pushed successfully"; success "Repository URL: https://github.com/$username/$project_name"; else info "Repository created but push failed"; info "You can push manually later with: git push -u origin $(git branch --show-current)"; info "Check your SSH keys: ssh -T git@github.com"; success "Repository URL: https://github.com/$username/$project_name"; fi
  else error "Failed to create GitHub repository"; fi
}

# >>> /home/pbjorklund/Projects/pbproject/src/tasks/init.sh
check_pbproject() {
  if [[ ! -d "$PBPROJECT_ROOT" ]]; then error "pbproject directory not found at $PBPROJECT_ROOT"; fi
  if [[ ! -f "$PBPROJECT_ROOT/bin/llm-setup" ]]; then error "llm-setup script not found at $PBPROJECT_ROOT/bin/llm-setup"; fi
  if [[ ! -d "$PBPROJECT_ROOT/project-templates" ]]; then error "project-templates directory not found at $PBPROJECT_ROOT/project-templates"; fi
}

init_project() {
  local project_name="${1:-}"
  if [[ -z "$project_name" ]]; then error "Project name is required"; fi
  local project_path display_name
  if [[ "$project_name" == "." ]]; then
    project_path="$PWD"; display_name="$(basename "$PWD")"
  else
    project_path="${2:-$PWD/$project_name}"; display_name="$project_name"
  fi
  check_pbproject
  info "Creating project directory: $project_path"; mkdir -p "$project_path"; cd "$project_path"
  if [[ ! -d .git ]]; then info "Initializing git repository"; git init; success "Git repository initialized"; else info "Git repository already exists"; fi
  info "Basic project structure created"
  if [[ ! -f README.md ]]; then sed "s/{{PROJECT_NAME}}/$display_name/g" "$PBPROJECT_ROOT/project-templates/README.md" > README.md; success "Created README.md"; fi
  if [[ ! -f .gitignore ]]; then cp "$PBPROJECT_ROOT/project-templates/.gitignore" .gitignore; success "Created .gitignore"; fi
  success "Project '$display_name' initialized at $project_path"
}

# >>> /home/pbjorklund/Projects/pbproject/src/tasks/migrate.sh
migrate_folder() {
  local folder_name="${1:-}"; local source_path="${2:-$PWD}"; if [[ -z "$folder_name" ]]; then error "Folder name is required"; fi
  local new_project_path current_dir
  if [[ "$folder_name" == "." ]]; then
    current_dir="$(basename "$PWD")"; new_project_path="$PROJECTS_DIR/$current_dir"
    if [[ "$PWD" == "$PROJECTS_DIR"/* ]] && [[ -d .git ]]; then error "Already in ~/Projects/ and is a git repository"; fi
    if [[ -e "$new_project_path" ]]; then error "Directory '$new_project_path' already exists"; fi
    info "Migrating current directory '$current_dir' to '$new_project_path'"; mkdir -p "$PROJECTS_DIR"; cd ..; mv "$current_dir" "$new_project_path"; cd "$new_project_path"
  else
    source_path=$(realpath "$source_path"); local source_folder="$source_path/$folder_name"
    if [[ ! -d "$source_folder" ]]; then error "Folder '$folder_name' not found in '$source_path'"; fi
    new_project_path="$PROJECTS_DIR/$folder_name"; if [[ -e "$new_project_path" ]]; then error "Directory '$new_project_path' already exists"; fi
    info "Migrating folder '$folder_name' to '$new_project_path'"; mkdir -p "$PROJECTS_DIR"; mv "$source_folder" "$new_project_path"; cd "$new_project_path"
  fi
  if [[ ! -d .git ]]; then git init; fi; git add .; git commit -m "Initial commit"; create_github_repo "$new_project_path"; success "Successfully migrated to '$new_project_path'"
}

# >>> /home/pbjorklund/Projects/pbproject/src/tasks/status.sh
show_status() {
  local project_path="${1:-$PWD}"; cd "$project_path"
  if [[ ! -d .git ]]; then error "Not in a git repository. Run this command in a project directory."; fi
  info "Project status for: $project_path"; echo
  echo "ðŸ“ Project: $(basename "$project_path")"; echo "ðŸ“‚ Path: $project_path"; echo
  echo "ðŸ”€ Git Information:"; local current_branch; current_branch=$(git branch --show-current 2>/dev/null || echo "unknown"); echo "   Branch: $current_branch"
  if ! git diff-index --quiet HEAD -- 2>/dev/null; then echo "   Status: âš ï¸  Uncommitted changes"; else echo "   Status: âœ… Clean working directory"; fi
  if git remote get-url origin &>/dev/null; then
    local remote_url; remote_url=$(git remote get-url origin); echo "   Remote: $remote_url"
    if [[ "$remote_url" == *"github.com"* ]]; then
      echo; echo "ðŸ™ GitHub Repository:"; local repo_info=""
      if [[ "$remote_url" == *"git@github.com:"* ]]; then repo_info=$(echo "$remote_url" | sed 's/git@github.com://' | sed 's/\.git$//');
      elif [[ "$remote_url" == *"https://github.com/"* ]]; then repo_info=$(echo "$remote_url" | sed 's|https://github.com/||' | sed 's/\.git$//'); fi
      if [[ -n "$repo_info" ]] && command -v gh &>/dev/null; then
        echo "   Repository: https://github.com/$repo_info"
        if gh repo view "$repo_info" &>/dev/null; then
          local visibility; visibility=$(gh repo view "$repo_info" --json visibility --jq .visibility 2>/dev/null || echo "unknown"); echo "   Visibility: $visibility"
          if git fetch origin &>/dev/null; then
            local ahead behind; ahead=$(git rev-list --count HEAD..origin/$current_branch 2>/dev/null || echo "0"); behind=$(git rev-list --count origin/$current_branch..HEAD 2>/dev/null || echo "0")
            if [[ "$ahead" -gt 0 ]] && [[ "$behind" -gt 0 ]]; then echo "   Sync: âš ï¸  $behind ahead, $ahead behind";
            elif [[ "$behind" -gt 0 ]]; then echo "   Sync: â¬†ï¸  $behind commits ahead";
            elif [[ "$ahead" -gt 0 ]]; then echo "   Sync: â¬‡ï¸  $ahead commits behind"; else echo "   Sync: âœ… Up to date"; fi
          fi
        else echo "   Status: âŒ Repository not accessible or doesn't exist"; fi
      else echo "   Repository: $repo_info (GitHub CLI not available for detailed info)"; fi
    fi
  else echo "   Remote: âŒ No remote configured"; echo; echo "ðŸ’¡ To create GitHub repository: pbproject newghrepo"; fi
  echo
  echo "ðŸ“‹ Project Structure:"; [[ -f README.md ]] && echo "   âœ… README.md" || echo "   âŒ README.md missing"; [[ -f .gitignore ]] && echo "   âœ… .gitignore" || echo "   âŒ .gitignore missing"
  if [[ -f package.json ]]; then echo "   ðŸ“¦ package.json (Node.js project)"; elif [[ -f Cargo.toml ]]; then echo "   ðŸ¦€ Cargo.toml (Rust project)"; elif [[ -f pyproject.toml ]] || [[ -f requirements.txt ]]; then echo "   ðŸ Python project"; elif [[ -f go.mod ]]; then echo "   ðŸ¹ go.mod (Go project)"; fi
  echo
  echo "ðŸ¤– AI Development Support:";
  if command -v llm-setup &>/dev/null; then llm-setup --status;
  elif [[ -x "$PBPROJECT_ROOT/bin/llm-setup" ]]; then "$PBPROJECT_ROOT/bin/llm-setup" --status;
  else echo "   âŒ llm-setup not found - LLM instruction files not configured"; echo "   ðŸ’¡ Run 'llm-setup' to add AI development support"; fi
}

# >>> /home/pbjorklund/Projects/pbproject/src/main.sh
show_help() {
  cat <<EOF
$SCRIPT_NAME - Project initialization and management tool

USAGE:
    $SCRIPT_NAME init <project-name> [project-path]
    $SCRIPT_NAME status [project-path]
    $SCRIPT_NAME migrate <folder-name> [source-project-path]
    $SCRIPT_NAME newghrepo [project-path]
    $SCRIPT_NAME --help
EOF
}

main() {
  print_version_note
  case "${1:-}" in
    init) shift; init_project "$@";;
    status) shift; show_status "$@";;
    migrate) shift; migrate_folder "$@";;
    newghrepo) shift; create_github_repo "$@";;
    --help|-h|help) show_help;;
    "") error "No command specified. Use '$SCRIPT_NAME --help' for usage.";;
    *) error "Unknown command: $1. Use '$SCRIPT_NAME --help' for usage.";;
  esac
}

main "$@"
