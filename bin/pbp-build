#!/usr/bin/env bash
set -euo pipefail
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
out="$ROOT_DIR/bin/pbp"
mkdir -p "$(dirname "$out")"
{
  cat "$ROOT_DIR/src/header.sh"
  # embed version and git sha
  ver="${VERSION:-$(git -C "$ROOT_DIR" describe --tags --always --dirty 2>/dev/null || echo dev)}"
  ts="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  echo "# Version: $ver"
  echo "# Built: $ts"
  echo "PBP_VERSION='$ver'"
  echo "PBP_BUILD_TIME='$ts'"
  echo
  for f in "$ROOT_DIR/src/lib"/*.sh "$ROOT_DIR/src/tasks"/*.sh; do
    [[ -f "$f" ]] || continue
    echo "# >>> $f"; cat "$f"; echo
  done
  echo "# >>> $ROOT_DIR/src/main.sh"; cat "$ROOT_DIR/src/main.sh"; echo
  echo 'main "$@"'
} >"$out.tmp"
chmod +x "$out.tmp"
mv "$out.tmp" "$out"
echo "Built $out"
